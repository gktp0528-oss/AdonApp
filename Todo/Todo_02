# Adon 채팅 기능 구현 현황 (2026-02-12)

## 완료된 작업

### 1. 타입 정의
- **파일**: `AdonApp/src/types/chat.ts` (신규)
- `Message` 인터페이스: id, senderId, text, createdAt, read
- `Conversation` 인터페이스: id, participants[], listingId, listingTitle, listingPhoto, lastMessage, lastMessageAt, lastSenderId, unreadCount, createdAt

### 2. chatService 생성
- **파일**: `AdonApp/src/services/chatService.ts` (신규)
- `getOrCreateConversation(buyerId, sellerId, listing)` — 기존 대화방 조회 또는 신규 생성
- `sendMessage(conversationId, senderId, text)` — 메시지 전송 + conversation 메타데이터 업데이트 (lastMessage, unreadCount)
- `watchMessages(conversationId, callback)` — 실시간 메시지 리스너 (asc 정렬)
- `watchConversations(userId, callback)` — 내 대화 목록 실시간 리스너 (최신순)
- `watchConversationById(conversationId, callback)` — 단일 대화방 실시간 리스너
- `markAsRead(conversationId, userId)` — 읽음 처리 (try/catch 포함)

### 3. Firestore 보안 규칙 업데이트
- **파일**: `AdonApp/firestore.rules`
- conversations: 참여자만 read/update, 인증 사용자가 참여자인 경우 create
- messages 서브컬렉션: 참여자만 read, 자신의 senderId로만 create

### 4. Firestore 복합 인덱스 추가
- **파일**: `AdonApp/firestore.indexes.json`
- `conversations`: participants(array-contains) + lastMessageAt(desc) — 대화 목록 쿼리용
- `conversations`: participants(array-contains) + listingId(asc) — 기존 대화 조회용

### 5. Navigation 타입 수정
- **파일**: `AdonApp/src/navigation/types.ts`
- `Chat: undefined` → `Chat: { conversationId: string }` 변경

### 6. ChatScreen 실시간 연동
- **파일**: `AdonApp/src/screens/ChatScreen.tsx`
- mock 데이터(CHATS, USERS) 의존 완전 제거
- `watchConversationById`로 대화방 메타 실시간 구독
- `watchMessages`로 메시지 실시간 수신
- `sendMessage`로 메시지 전송
- 진입 시 `markAsRead` 호출
- 상대방 프로필 자동 로드 (userService.watchUserById)
- 메시지 타임스탬프 표시, 자동 스크롤

### 7. ChatListScreen 실시간 연동
- **파일**: `AdonApp/src/screens/ChatListScreen.tsx`
- 하드코딩 conversations 배열 제거
- `watchConversations`로 내 대화 목록 실시간 구독
- 상대방 유저 프로필 자동 로드 (userCache)
- unreadCount 기반 안읽음 표시
- 검색/필터 유지 (이름, 메시지, 상품명 검색)

### 8. ProductScreen 채팅 시작 플로우
- **파일**: `AdonApp/src/screens/ProductScreen.tsx`
- 채팅/구매 버튼 → `chatService.getOrCreateConversation` 호출
- conversationId를 받아 `Chat` 화면으로 navigate
- 자기 자신 상품에는 채팅 시작 안 됨 (sellerId === currentUserId 체크)

---

## antigravity가 해야 할 작업

### 필수 (채팅 기능 완성)
1. **Firestore 인덱스 배포**: `firebase deploy --only firestore:indexes` 실행 필요. 안 하면 conversations 쿼리에서 `FAILED_PRECONDITION` 에러 발생
2. **Firestore 보안 규칙 배포**: `firebase deploy --only firestore:rules`
3. **로그인 안 된 상태 대응**: 현재 `userService.getCurrentUserId()`가 미로그인 시 `temp_seller_123` 반환 → 채팅은 인증 필수이므로, ProductScreen에서 미로그인 시 채팅 버튼 클릭 → 로그인 화면 유도 로직 추가 필요
4. **빈 대화방 UX**: 대화 시작 직후 메시지가 없을 때 안내 문구 개선 (현재 "Start your conversation!" 하드코딩 → i18n 키 추가)

### 권장 (UX 개선)
5. **BottomTab 뱃지**: ChatList 탭에 총 안읽음 수 뱃지 표시
6. **ChatListScreen 상대방 온라인 표시**: 현재 unread 여부로 onlineDot 표시 중 → 실제 온라인 상태 기반으로 변경하려면 users 컬렉션에 `lastActive` 필드 추가 필요
7. **메시지 페이지네이션**: 현재 전체 메시지를 한번에 로드 → 대화가 길어지면 `limit` + `startAfter`로 페이지네이션 필요
8. **이미지 메시지**: Message 타입에 `imageUrl?` 필드 추가 + Firebase Storage 연동
9. **푸시 알림**: Firebase Cloud Messaging 연동 (새 메시지 도착 시 알림)

### 기존 에러 (채팅과 무관)
- `SneakersListScreen.tsx` 149줄, 207줄: `"search"`가 `TabKey` 타입에 없음 → tabRouting.ts에서 TabKey 정의 확인 후 수정 필요
- `firebaseConfig.ts`: `getVertexAI` 모듈 누락으로 `aiBackend = null` 임시 처리됨 → AI 기능 사용 시 firebase/vertexai 패키지 설치 필요

---

## Firestore 데이터 구조

```
conversations/{conversationId}
├── participants: string[]        // [buyerId, sellerId]
├── listingId: string
├── listingTitle: string
├── listingPhoto: string
├── lastMessage: string
├── lastMessageAt: Timestamp
├── lastSenderId: string
├── unreadCount: { [userId]: number }
├── createdAt: Timestamp
│
└── messages/{messageId}          // 서브컬렉션
    ├── senderId: string
    ├── text: string
    ├── createdAt: Timestamp
    └── read: boolean
```

## 변경 파일 목록
- `src/types/chat.ts` — 신규
- `src/services/chatService.ts` — 신규
- `src/screens/ChatScreen.tsx` — 전면 수정
- `src/screens/ChatListScreen.tsx` — 전면 수정
- `src/screens/ProductScreen.tsx` — chatService import + handleStartChat 추가
- `src/navigation/types.ts` — Chat 파라미터 변경
- `firestore.rules` — conversations/messages 규칙 추가
- `firestore.indexes.json` — 복합 인덱스 2개 추가
