# Adon Search 고도화 실행 계획 (for antigravity)

## 목적
- 10,000명 사용자 규모에서도 검색 UX/성능/정확도를 유지할 수 있는 구조로 전환한다.
- 현재 `Recent + 타이핑 시 연관 키워드` UI를 유지하되, 추천/검색 데이터 소스를 mock에서 실제 데이터 기반으로 교체한다.

## 현재 상태 요약
- 홈 헤더 검색 진입: `QuerySearchScreen`으로 연결됨.
- 검색 화면: 입력 없을 때 `Recent`, 입력 시 `Related Keywords` 노출.
- 연관 키워드: 현재 mock + recent 기반(실제 게시물/로그 기반 아님).
- 기술 부채: 검색 전용 서비스/로그/인덱스 파이프라인 부재.

## 최종 산출물(이번 트랙)
1. 앱에서 mock 없는 실제 `suggest/search` 호출
2. 검색 로그 적재 (`search_logs`)
3. 키워드 통계 집계 (`keyword_stats`) 배치
4. 게시물 변경 시 검색 인덱스 동기화 파이프라인
5. 성능/품질 지표 대시보드 최소 셋

## 아키텍처 원칙
1. Firestore는 원본 데이터 저장소
2. 검색/추천은 인덱스 저장소(Algolia/Typesense/OpenSearch 중 1개)로 분리
3. 앱은 `searchService` 인터페이스만 의존
4. 랭킹은 초기에 규칙 기반, 이후 로그 기반 가중치 보정

## 단계별 실행 계획

### Phase 0: 인터페이스 고정 (반드시 먼저)
- 목표: 앱 레이어를 먼저 고정해 이후 백엔드 교체 리스크 최소화
- 작업:
  1. `AdonApp/src/services/searchService.ts` 생성
  2. API 시그니처 정의:
     - `getSuggestions(query: string, userId?: string): Promise<string[]>`
     - `searchListings(query: string, options?): Promise<Listing[]>`
     - `trackSearch(query: string, meta?): Promise<void>`
     - `trackClick(query: string, listingId: string, position: number, meta?): Promise<void>`
  3. `QuerySearchScreen`에서 mock 의존 제거, `getSuggestions` 연동
- 완료 기준:
  - 입력 시 네트워크 호출로 추천 키워드 표시
  - 검색 실행 시 `trackSearch` 호출

### Phase 1: 추천 키워드(Autocomplete) 실데이터화
- 목표: recent/mock 대신 실제 데이터로 관련 키워드 생성
- 추천 후보 소스(초기):
  1. 최근 검색어(recent)
  2. 인기 키워드(`keyword_stats`)
  3. 게시물 토큰(title/category/tags prefix)
- 랭킹 규칙(초기 점수식):
  - `score = prefixMatchWeight + popularityWeight + recencyWeight`
- 완료 기준:
  - 최소 8개 이하 추천 반환
  - 빈 입력 시 recent만 노출 유지
  - p95 추천 응답 200ms 이내(스테이징 기준)

### Phase 2: 검색 결과 품질 개선
- 목표: 검색 결과 정확도/재현율 개선
- 작업:
  1. 인덱스 문서 구조 확정:
     - `listingId`, `title`, `category`, `tags`, `price`, `createdAt`, `popularityScore`
  2. 검색 쿼리 규칙:
     - prefix + typo tolerance + category boost
  3. 결과 0건 fallback:
     - 유사 키워드 제안 + 인접 카테고리 제안
- 완료 기준:
  - 0건 검색률 12% 이하(초기 목표)
  - 주요 카테고리(의류/리빙/테크) 수동 테스트 통과

### Phase 3: 로그/집계 파이프라인
- 목표: 랭킹 학습에 필요한 행동 데이터 축적
- 컬렉션:
  1. `search_logs`
     - `query`, `userId`, `sessionId`, `clickedListingId`, `position`, `timestamp`
  2. `keyword_stats`
     - `keyword`, `searchCount`, `clickCount`, `ctr`, `updatedAt`
- 작업:
  1. `trackSearch`, `trackClick` 서버 적재
  2. 배치(예: 1시간/1일)로 `keyword_stats` 갱신
- 완료 기준:
  - 로그 누락률 < 1%
  - 키워드 통계가 주기적으로 갱신됨

### Phase 4: 실험/운영 체계
- 목표: 감으로 고치지 않고 실험으로 개선
- 작업:
  1. A/B 플래그 1개 추가 (`ranking_v1` vs `ranking_v2`)
  2. 지표 수집:
     - Suggest CTR
     - Search 결과 클릭률
     - 0건 검색률
     - 응답시간 p95
- 완료 기준:
  - 주간 리포트 확인 가능
  - 랭킹식 변경 시 비교 가능

## antigravity 작업 지시(우선순위 순)
1. `searchService` 인터페이스부터 구현하고 `QuerySearchScreen` 연결
2. 추천 API 최소 버전 구현(인기 + recent + prefix)
3. 검색 실행/클릭 로깅 붙이기
4. 집계 배치 붙여 `keyword_stats` 자동 업데이트
5. 이후 인덱스 고도화(typo/synonym/personalization)는 별도 PR

## 파일 단위 변경 가이드
- 앱:
  - `AdonApp/src/services/searchService.ts` (신규)
  - `AdonApp/src/screens/QuerySearchScreen.tsx` (mock 제거, debounce 호출)
  - 필요 시 `AdonApp/src/types/listing.ts` (검색 응답 타입 보강)
- 백엔드/함수(프로젝트 정책에 맞춰 경로 선택):
  - `functions/search/*` 또는 동등 모듈
  - 로그 적재, suggest/search endpoint, 집계 job

## DoD (Definition of Done)
- 기능:
  1. 입력 시 실제 추천 노출
  2. 검색 결과 페이지 정상 노출
  3. 클릭 로그 누적
- 성능:
  1. suggest p95 < 200ms
  2. search p95 < 400ms
- 품질:
  1. 크래시 0
  2. 0건률 모니터링 가능
  3. 회귀 테스트 시 기존 홈→검색 진입 플로우 정상

## 리스크 및 대응
- 리스크: Firestore 직접 검색 확장 한계
  - 대응: 검색 인덱스 분리 우선
- 리스크: 초기 데이터 부족으로 랭킹 불안정
  - 대응: 규칙 기반 기본점수 + 로그 기반 보정 점진 적용
- 리스크: i18n 키 충돌/오타
  - 대응: 신규 키 추가 시 `en/ko/hu` 동시 반영 체크리스트 운영

## 커밋 전략
1. `feat(search): add searchService interface and wire QuerySearchScreen`
2. `feat(search): implement suggest API and keyword ranking v1`
3. `feat(search): add search/click tracking and keyword_stats batch`
4. `chore(search): add metrics dashboard and ab flag plumbing`
